@page "/reports"
@rendermode InteractiveServer
@using ComputerStore.Services
@using ComputerStore.Models
@using ComputerStore.Models.DTOs
@using ComputerStore.Data
@using ComputerStore.Components.Reports
@using Microsoft.EntityFrameworkCore
@inject IReportService ReportService
@inject ApplicationDbContext DbContext

<PageTitle>Отчеты</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">Отчеты</h1>
            <p class="lead text-muted">Выберите необходимый отчет</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Навигация по отчетам -->
        <div class="col-lg-3">
            <div class="list-group sticky-top" style="top: 20px;">
                <a class="list-group-item list-group-item-action @(activeReport == "storeEquipment" ? "active" : "")"
                   @onclick='() => SelectReport("storeEquipment")' style="cursor: pointer;">
                    <i class="bi bi-box-seam me-2"></i>Товары в торговом зале
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "warehouse" ? "active" : "")"
                   @onclick='() => SelectReport("warehouse")' style="cursor: pointer;">
                    <i class="bi bi-building me-2"></i>Состояние склада
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "totalWarehouse" ? "active" : "")"
                   @onclick='() => SelectReport("totalWarehouse")' style="cursor: pointer;">
                    <i class="bi bi-archive me-2"></i>Общий склад
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "sellerSales" ? "active" : "")"
                   @onclick='() => SelectReport("sellerSales")' style="cursor: pointer;">
                    <i class="bi bi-person-badge me-2"></i>Сделки продавца
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "sellersReport" ? "active" : "")"
                   @onclick='() => SelectReport("sellersReport")' style="cursor: pointer;">
                    <i class="bi bi-people me-2"></i>Отчет продавцов
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "popular" ? "active" : "")"
                   @onclick='() => SelectReport("popular")' style="cursor: pointer;">
                    <i class="bi bi-star me-2"></i>Популярные товары
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "revenue" ? "active" : "")"
                   @onclick='() => SelectReport("revenue")' style="cursor: pointer;">
                    <i class="bi bi-cash-stack me-2"></i>Доход фирмы
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "unsold" ? "active" : "")"
                   @onclick='() => SelectReport("unsold")' style="cursor: pointer;">
                    <i class="bi bi-clock-history me-2"></i>Нереализованные товары
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "sellerOrders" ? "active" : "")"
                   @onclick='() => SelectReport("sellerOrders")' style="cursor: pointer;">
                    <i class="bi bi-clipboard-check me-2"></i>Заказы продавца
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "weeklyOrders" ? "active" : "")"
                   @onclick='() => SelectReport("weeklyOrders")' style="cursor: pointer;">
                    <i class="bi bi-calendar-week me-2"></i>Недельный заказ
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "schedule" ? "active" : "")"
                   @onclick='() => SelectReport("schedule")' style="cursor: pointer;">
                    <i class="bi bi-calendar3 me-2"></i>График работы
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "turnover" ? "active" : "")"
                   @onclick='() => SelectReport("turnover")' style="cursor: pointer;">
                    <i class="bi bi-graph-up me-2"></i>Торговый оборот
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "violations" ? "active" : "")"
                   @onclick='() => SelectReport("violations")' style="cursor: pointer;">
                    <i class="bi bi-exclamation-triangle me-2"></i>Превышения лимита
                </a>
                <a class="list-group-item list-group-item-action @(activeReport == "monthly" ? "active" : "")"
                   @onclick='() => SelectReport("monthly")' style="cursor: pointer;">
                    <i class="bi bi-file-earmark-text me-2"></i>Ежемесячный отчет
                </a>
            </div>
        </div>

        <!-- Содержимое отчета -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        @switch (activeReport)
                        {
                            case "storeEquipment":
                                <ReportStoreEquipment Data="@storeEquipmentData" 
                                                     StorePoints="@storePoints"
                                                     OnFilterChanged="LoadStoreEquipment" />
                                break;
                            case "warehouse":
                                <ReportWarehouse Data="@warehouseData" 
                                               OnFilterChanged="LoadWarehouse" />
                                break;
                            case "totalWarehouse":
                                <ReportTotalWarehouse Data="@totalWarehouseData" />
                                break;
                            case "sellerSales":
                                <ReportSellerSales Data="@sellerSalesData"
                                                  Sellers="@sellers"
                                                  OnFilterChanged="LoadSellerSales" />
                                break;
                            case "sellersReport":
                                <ReportSellers Data="@sellersReportData"
                                             OnFilterChanged="LoadSellersReport" />
                                break;
                            case "popular":
                                <ReportPopular Data="@popularData"
                                             OnFilterChanged="LoadPopular" />
                                break;
                            case "revenue":
                                <ReportRevenue Data="@revenueData"
                                             OnFilterChanged="LoadRevenue" />
                                break;
                            case "unsold":
                                <ReportUnsold Data="@unsoldData"
                                            OnFilterChanged="LoadUnsold" />
                                break;
                            case "sellerOrders":
                                <ReportSellerOrders Data="@sellerOrdersData"
                                                   Sellers="@sellers"
                                                   OnFilterChanged="LoadSellerOrders" />
                                break;
                            case "weeklyOrders":
                                <ReportWeeklyOrders Data="@weeklyOrdersData"
                                                   OnFilterChanged="LoadWeeklyOrders" />
                                break;
                            case "schedule":
                                <ReportSchedule Data="@scheduleData"
                                              Sellers="@sellers"
                                              OnFilterChanged="LoadSchedule" />
                                break;
                            case "turnover":
                                <ReportTurnover Data="@turnoverData"
                                              OnFilterChanged="LoadTurnover" />
                                break;
                            case "violations":
                                <ReportViolations Data="@violationsData" />
                                break;
                            case "monthly":
                                <ReportMonthly Data="@monthlyData"
                                             OnFilterChanged="LoadMonthly" />
                                break;
                            default:
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-file-earmark-text display-1"></i>
                                    <p class="mt-3">Выберите отчет из списка слева</p>
                                </div>
                                break;
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string activeReport = "";
    private bool isLoading = false;

    private List<StorePoint> storePoints = new();
    private List<Seller> sellers = new();

    private List<StorePointEquipmentDto> storeEquipmentData = new();
    private List<WarehouseStateDto> warehouseData = new();
    private List<TotalWarehouseDto> totalWarehouseData = new();
    private List<SellerSalesDto> sellerSalesData = new();
    private List<SellerReportDto> sellersReportData = new();
    private List<PopularProductDto> popularData = new();
    private RevenueReportDto? revenueData;
    private List<UnsoldProductDto> unsoldData = new();
    private List<SellerOrderDto> sellerOrdersData = new();
    private List<WeeklySupplierOrderDto> weeklyOrdersData = new();
    private List<SellerScheduleDto> scheduleData = new();
    private List<StorePointTurnoverDto> turnoverData = new();
    private List<CashLimitViolationDto> violationsData = new();
    private List<MonthlyReportDto> monthlyData = new();

    protected override async Task OnInitializedAsync()
    {
        storePoints = await DbContext.StorePoints.ToListAsync();
        sellers = await DbContext.Sellers.OrderBy(s => s.LastName).ToListAsync();
    }

    private async Task SelectReport(string reportName)
    {
        activeReport = reportName;
        await LoadReportData();
    }

    private async Task LoadReportData()
    {
        isLoading = true;
        try
        {
            switch (activeReport)
            {
                case "totalWarehouse":
                    totalWarehouseData = await ReportService.GetTotalWarehouse();
                    break;
                case "violations":
                    violationsData = await ReportService.GetCashLimitViolations();
                    break;
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadStoreEquipment(int storePointId)
    {
        isLoading = true;
        try
        {
            storeEquipmentData = await ReportService.GetStorePointEquipment(storePointId);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadWarehouse(DateTime date)
    {
        isLoading = true;
        try
        {
            warehouseData = await ReportService.GetCentralWarehouseState(date);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSellerSales(int sellerId)
    {
        isLoading = true;
        try
        {
            sellerSalesData = await ReportService.GetSellerSales(sellerId);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSellersReport((DateTime Start, DateTime End) dates)
    {
        isLoading = true;
        try
        {
            sellersReportData = await ReportService.GetSellersSalesReport(dates.Start, dates.End);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadPopular((DateTime Start, DateTime End) dates)
    {
        isLoading = true;
        try
        {
            popularData = await ReportService.GetPopularProducts(dates.Start, dates.End);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadRevenue((DateTime Start, DateTime End) dates)
    {
        isLoading = true;
        try
        {
            revenueData = await ReportService.GetRevenueReport(dates.Start, dates.End);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadUnsold((DateTime Start, DateTime End) dates)
    {
        isLoading = true;
        try
        {
            unsoldData = await ReportService.GetUnsoldProducts(dates.Start, dates.End);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSellerOrders(int sellerId)
    {
        isLoading = true;
        try
        {
            sellerOrdersData = await ReportService.GetSellerOrders(sellerId);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadWeeklyOrders(DateTime weekStart)
    {
        isLoading = true;
        try
        {
            weeklyOrdersData = await ReportService.GetWeeklySupplierOrders(weekStart);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSchedule((int SellerId, int Month, int Year) filter)
    {
        isLoading = true;
        try
        {
            scheduleData = await ReportService.GetSellerSchedule(filter.SellerId, filter.Month, filter.Year);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTurnover((int Month, int Year) filter)
    {
        isLoading = true;
        try
        {
            turnoverData = await ReportService.GetStorePointTurnover(filter.Month, filter.Year);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadMonthly((int Month, int Year) filter)
    {
        isLoading = true;
        try
        {
            monthlyData = await ReportService.GetMonthlyReport(filter.Month, filter.Year);
        }
        finally
        {
            isLoading = false;
        }
    }
}